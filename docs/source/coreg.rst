CT to SAXS volume coregistration
==================================

.. _Overview:

Overview
------------
Describes the steps in aligning the CT 3D image to the SAXS maps, including fixing coordinate system, downsampling of CT to SAXS voxel size, parameters from CT per SAXS voxel.

Prerequisite data:
a. TomoSAXS dataset.
b. Coarse SAXS mapping dataset of the respective sample (per-frame sum SAXS scattering).
c. CT dataset.
d. Resliced and inverted copy of CT dataset at same orientation as coarse WAXS map (See CT Processing page - [update to hyperlink once page complete]).
e. Segmentation dataset of kapton tube (from CT data)
f. Fibre tracing dataset of CT data (volumetric datasets with greyscale values corresponding to estimated 3D collagen fibre orientations).
g. Fibre tracing "vox_padding" excel file - used for padding of fibre tracing data. NB - the names given to tomoSAXS scans in this file are used verbatim in this registration process.

TomoSAXS operates along a number of discrete vertical "slices": lateral axes that the scan was conducted over, seperated vertically to form 3D voxels. 
These need to be registered spatially with the corresponding CT data, so that fibres isolated during fibre tracing are 

Steps are:
1. Register vertical axis between resliced CT dataset and coarse mapping of tomoSAXS dataset.
  Registration uses the offset between vertebrae end-points surrounding the respective IVD.
  The offset is provided with absolute values from coarse SAXS map. 
  This calibration also allows estimation of which CT slices represent the regions investigated in the tomoSAXS scan.

2. Pad fibre tracing data.
  The Fibre tracing technique sumsamples and downsamples original CT data. This process adds ampty voxels to fibre tracing data so that the fibre tracing data returns to 
  the same dimensions as the original CT data.
  Padded data can then be registered with SAXS data both `vertically <.. vert_reg:>`_ and horizontally.
  The padded fibre tracing slices that vertically correspond to the slices of the tomoSAXS scan are then isolated and saved.
 
3. Register horizontal axis between padded firbe tracing data and SAXS data for each orientation in tomoSAXS scan.
  This process uses a seperate volume taken from the original CT volume, consisting of a segmented region of the kapton tube surrounding the sample.
  This volume is subsampled, alongside the  fibre-tracing dataset, to slices comprising the tomoSAXS scanned region.
  The data (both kapton segmentation and fibre tracing data) is rotated to correspond to each angular rotation of the tomoSAXS scan (e.g. -90 – 00 – 90).
  For each rotation, the kapton segmentation is treated as a coord, to estimate the complete extent of the kapton tube as a circle. The space between the inside edges of the kapton tube and the traced fibres is estimated (in um).
  The outer edge of the kapton tube is found in both this data, and the SAXS data for the respective orientation for each slice of the tomoSAXS scan.
  The offset is then calculated between these edges, and the fibre tracing data further padded to account for this offset

3. Downsample registered fibre tracing data and save for tomoSAXS analysis.
  The registered fibre tracing data can finally be processed into it's corresponding tomoSAXS voxels/beamptahs.

.. load_data:
Loading data
------------

Data for each scan is loaded using a series of GUIs.

the first:

.. image:: final_gui.png

reads in:
a. "Scan name" - the name given to the tomoSAXS scan in the accompanying fibre tracing "vix_padding" excel file.
b. "Original CT data" - the folder containing the original CT data.
c. "Inverted resliced CT map" - the file comprising the resliced, grayscale inverted CT map corresponding to the coarse WAXS map used for registration.
d. "Kapton CT dataset" - the folder containing the segmented kapton tube data.
e. "Beta/phi fibre tracing data" - the folder containing the (original unpadded) beta/phi fibre tracing data.
f. "Alpha/theta fibre tracing data" - the folder containing the (original unpadded) alpha/theta fibre tracing data.
g. "WAXS map data" - the .nxs file of the coarse WAXS map. 
g. "Output folder" - the folder that the user wishes to output data generated by the registration script (example figures and tables).
h. "Original CT voxel size (um)" - The voxel size of the original CT data in microns.
i. "Inverted CT voxel size (um)" - The voxel size of the inverted CT data (may be adjusted if processed on a laptop due to limited computing power).
j. "Kapton data voxel size (um)" - The voxel size of the kapton segmented data (may be adjusted if processed on a laptop due to limited computing power).
k. "Fibre tracing voxel scale" - The downsampling scale used for fibre tracing data creation.
l. "Kapton tube diameter (um) - diameter of kapton tube in microns.
m. "SAXS rotational direction" - direction of rotation for tomoSAXS scan.

the second:

.. image:: saxs_select_GUI.png
  :width: 400

Allows selection of individual files that make up the tomoSAXS scan.

the third:

.. image:: saxs_scan_gui.png

Reads in:
a. "Number of rotational angles in tomoSAXS scan".
b. "start angle" - axis orientation of the first orientation of the tomoSAXS scan.
c. "end angle" - axis orientation of the last orientation of the tomoSAXS scan.
d. "angle of WAXS map".

.. vert_reg:
1. Vertical registration
---------------------
1.a. Load WAXS sum intensity map. 

.. image:: WAXS_map_scaled.png

1.b. User selects endpoint of the upper vertebra in WAXS data.

.. image:: WAXS_map_top_vert_endpoint.png

1.c. Now, the inverted and resliced CT data is loaded:

.. image:: raw_inverse_CT.png

1.d. and user selects endpoint of the upper vertebra in CT data.

.. image:: Upper_vertebral_endpoint_in_CT_map.png

1.e. The offset between the vertebral endpoint and the tomoSAXS slices can now be calculated by loading the first orientation of the tomoSAXS scan, and comparing the y axis coordinates of each slice with that of the vertebral endpoint:

.. image:: CT_map_with tomoSAXS_slices.png

.. image:: registered_fib_trac_gif.gif

.. padding:
1. Padding of fibre tracing data
--------------------------------
For both the Beta/phi fibre tracing data; and alpha/theta fibre tracing data: 
2.a. Load fibre tracing data 

.. image:: example_fibre_tracing.png

2.b. Load padding values from the "vox_padding" excel file.

.. image:: vox_padding.png

2.c. Create empty arrays wth shapes corresponding to the padding dimensions and concatenate with fibre tracing data:

.. image:: Example_alpha_fibre_tracing_tomoSAXS_slice_0.png

2.d. Isolate and save padded fibre tracing slices that correspond to tomoSAXS slices.



.. _coordinates:
Coordinate systems
-------------------
Coordinate systems for CT and SAXS. related Figures

.. _downsampling:
Downsampling 
------------------
1. Method of downsampling, code example
2. Regular grid or cluster; where this is selected for in code

.. _parameters:
CT parameters
--------------------
Direction of orientation and degree of orientation per voxel or fibre cluster. related: 3D SAXS simulation of fibre with variable wMu
